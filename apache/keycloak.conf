<VirtualHost *:80>
  ServerName sandbox.auth.library.ucdavis.edu
  Redirect permanent / https://sandbox.auth.library.ucdavis.edu/
</VirtualHost>
<IfModule mod_ssl.c>
  <VirtualHost *:443>
    ServerName sandbox.auth.library.ucdavis.edu

    <Location "/">
      RewriteEngine On
      # remove all GA and Hotjar cookies
      RewriteCond %{HTTP:Cookie} ^(.*)(ga_[^;]+|_hj[^;]+;?)(.*)$ [NC]
      RewriteRule .* - [E=MODIFIED_COOKIE:%1%3]
      Header set Cookie "%{MODIFIED_COOKIE}e" env=MODIFIED_COOKIE
    </Location>

    <Location "/admin">
        Require ip 172.19.19.0/24 169.237.102.0/26 169.237.102.128/25
    </Location>
    <Location "/js">
        Require ip 172.19.19.0/24 169.237.102.0/26 169.237.102.128/25
    </Location>
    <Location "/welcome">
        Require ip 172.19.19.0/24 169.237.102.0/26 169.237.102.128/25
    </Location>
    <Location "/metrics">
        Require ip 172.19.19.0/24 169.237.102.0/26 169.237.102.128/25
    </Location>
    <Location "/health">
        Require ip 172.19.19.0/24 169.237.102.0/26 169.237.102.128/25
    </Location>

    ProxyPreserveHost On
    ProxyRequests Off
    RequestHeader set x-forwarded-proto "https"
    RequestHeader set x-ssl-client-cert "%{SSL_CLIENT_CERT}s"

    # Hot spare configuration with health checks
    # Define upstream servers
    ProxyPass /health/balancer-manager !
    <Location "/health/balancer-manager">
        SetHandler balancer-manager
        Require ip 172.19.19.0/24 169.237.102.0/26 169.237.102.128/25
    </Location>

    # Primary and spare Keycloak instances with health checks
    ProxyPass / balancer://keycloak-cluster/
    ProxyPassReverse / balancer://keycloak-cluster/
    
    <Proxy balancer://keycloak-cluster>
        # Primary instance
        BalancerMember http://localhost:3123 status=+H
        # Hot spare instance
        BalancerMember http://localhost:3124 status=+H
        # Health check configuration
        ProxySet retry=300
        ProxySet ping=5
    </Proxy>

    SSLEngine on
    SSLCertificateFile  /etc/ssl/certs/auth_library_ucdavis_edu_cert.cer
    SSLCertificateKeyFile /etc/pki/tls/private/auth.library.ucdavis.edu.key
    SSLCertificateChainFile /etc/ssl/certs/incommon_interm.cer

  </VirtualHost>
</IfModule>
